
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="protoplast">
      
      
        <meta name="author" content="dataxight">
      
      
        <link rel="canonical" href="https://protoplast.dataxight.com/apis/scrna/">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>SCRNA API References - PROTOplast</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="deep-orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#scrna-api-references" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="PROTOplast" class="md-header__button md-logo" aria-label="PROTOplast" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PROTOplast
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              SCRNA API References
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="deep-orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="deep-orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/dataxight/protoplast" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    dataxight/protoplast
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="PROTOplast" class="md-nav__button md-logo" aria-label="PROTOplast" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    PROTOplast
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/dataxight/protoplast" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    dataxight/protoplast
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../readme/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Readme
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorials/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tutorials
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../history/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    History
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#trainer" class="md-nav__link">
    <span class="md-ellipsis">
      Trainer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protoplast.scrna.anndata.trainer.RayTrainRunner" class="md-nav__link">
    <span class="md-ellipsis">
      RayTrainRunner
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RayTrainRunner">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#protoplast.scrna.anndata.trainer.RayTrainRunner.inference" class="md-nav__link">
    <span class="md-ellipsis">
      inference
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protoplast.scrna.anndata.trainer.RayTrainRunner.par_inference" class="md-nav__link">
    <span class="md-ellipsis">
      par_inference
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protoplast.scrna.anndata.trainer.RayTrainRunner.train" class="md-nav__link">
    <span class="md-ellipsis">
      train
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#datamodule" class="md-nav__link">
    <span class="md-ellipsis">
      DataModule
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protoplast.scrna.anndata.torch_dataloader.AnnDataModule" class="md-nav__link">
    <span class="md-ellipsis">
      AnnDataModule
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dataset" class="md-nav__link">
    <span class="md-ellipsis">
      Dataset
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protoplast.scrna.anndata.torch_dataloader.DistributedAnnDataset" class="md-nav__link">
    <span class="md-ellipsis">
      DistributedAnnDataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DistributedAnnDataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#protoplast.scrna.anndata.torch_dataloader.DistributedAnnDataset.transform" class="md-nav__link">
    <span class="md-ellipsis">
      transform
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protoplast.scrna.anndata.strategy.ShuffleStrategy" class="md-nav__link">
    <span class="md-ellipsis">
      ShuffleStrategy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ShuffleStrategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#protoplast.scrna.anndata.strategy.ShuffleStrategy.mixer" class="md-nav__link">
    <span class="md-ellipsis">
      mixer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protoplast.scrna.anndata.strategy.ShuffleStrategy.split" class="md-nav__link">
    <span class="md-ellipsis">
      split
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protoplast.scrna.anndata.strategy.SplitInfo" class="md-nav__link">
    <span class="md-ellipsis">
      SplitInfo
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SplitInfo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#protoplast.scrna.anndata.strategy.SplitInfo.mini_batch_size" class="md-nav__link">
    <span class="md-ellipsis">
      mini_batch_size
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protoplast.scrna.anndata.strategy.SequentialShuffleStrategy" class="md-nav__link">
    <span class="md-ellipsis">
      SequentialShuffleStrategy
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="scrna-api-references">SCRNA API References<a class="headerlink" href="#scrna-api-references" title="Permanent link">&para;</a></h1>
<h2 id="trainer">Trainer<a class="headerlink" href="#trainer" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-class">



<h2 id="protoplast.scrna.anndata.trainer.RayTrainRunner" class="doc doc-heading">
            <code>protoplast.scrna.anndata.trainer.RayTrainRunner</code>


<a href="#protoplast.scrna.anndata.trainer.RayTrainRunner" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">


        <p>A class to initialize the training this class automatically initializes Ray cluster or
detect whether an existing cluster exist if there is an existing cluster it will automatically
connect to it refer to <code>ray.init()</code> behavior</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>Model</code>
            </td>
            <td>
                  <code><span title="type">type</span>[<span title="lightning.pytorch.LightningModule">LightningModule</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PyTorch Lightning model class</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>Ds</code>
            </td>
            <td>
                  <code><span title="type">type</span>[<a class="autorefs autorefs-internal" title="protoplast.scrna.anndata.torch_dataloader.DistributedAnnDataset" href="#protoplast.scrna.anndata.torch_dataloader.DistributedAnnDataset">DistributedAnnDataset</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DistributedAnnDataset class</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>model_keys</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Keys to pass to model from <code>metadata_cb</code></p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>metadata_cb</code>
            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[<span title="anndata.AnnData">AnnData</span>, <span title="dict">dict</span>], None]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Callback to mutate metadata recommended for passing data from <code>obs</code> or <code>var</code>
or any additional data your models required
by default cell_line_metadata_cb</p>
              </div>
            </td>
            <td>
                  <code><span title="protoplast.scrna.anndata.torch_dataloader.cell_line_metadata_cb">cell_line_metadata_cb</span></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>before_dense_cb</code>
            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[<span title="torch.Tensor">Tensor</span>, <span title="str">str</span> | <span title="int">int</span>], <span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Callback to perform before densification of sparse matrix where the data at this point
is still a sparse CSR Tensor, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>after_dense_cb</code>
            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[<span title="torch.Tensor">Tensor</span>, <span title="str">str</span> | <span title="int">int</span>], <span title="torch.Tensor">Tensor</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Callback to perform after densification of sparse matrix where the data at this point
is a dense Tensor, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>shuffle_strategy</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="protoplast.scrna.anndata.strategy.ShuffleStrategy" href="#protoplast.scrna.anndata.strategy.ShuffleStrategy">ShuffleStrategy</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Strategy to split or randomize the data during the training, by default SequentialShuffleStrategy</p>
              </div>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="protoplast.scrna.anndata.strategy.SequentialShuffleStrategy" href="#protoplast.scrna.anndata.strategy.SequentialShuffleStrategy">SequentialShuffleStrategy</a></code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>runtime_env_config</code>
            </td>
            <td>
                  <code><span title="dict">dict</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>These env config is to pass the RayTrainer processes, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>address</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Override ray address, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ray_trainer_strategy</code>
            </td>
            <td>
                  <code><span title="lightning.pytorch.strategies.Strategy">Strategy</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Override Ray Trainer Strategy if this is None it will default to RayDDP, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sparse_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><em>description</em>, by default "X",</p>
              </div>
            </td>
            <td>
                  <code>&#39;X&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="protoplast.scrna.anndata.trainer.RayTrainRunner" href="#protoplast.scrna.anndata.trainer.RayTrainRunner">RayTrainRunner</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Use this class to start the training</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/protoplast/scrna/anndata/trainer.py</code></summary>
                <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-115" name="__codelineno-0-115"></a><span class="k">class</span><span class="w"> </span><span class="nc">RayTrainRunner</span><span class="p">:</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A class to initialize the training this class automatically initializes Ray cluster or</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><span class="sd">    detect whether an existing cluster exist if there is an existing cluster it will automatically</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><span class="sd">    connect to it refer to `ray.init()` behavior</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><span class="sd">    Model : type[pl.LightningModule]</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><span class="sd">        PyTorch Lightning model class</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><span class="sd">    Ds : type[DistributedAnnDataset]</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><span class="sd">        DistributedAnnDataset class</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><span class="sd">    model_keys : list[str]</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><span class="sd">        Keys to pass to model from `metadata_cb`</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><span class="sd">    metadata_cb : Callable[[anndata.AnnData, dict], None], optional</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><span class="sd">        Callback to mutate metadata recommended for passing data from `obs` or `var`</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><span class="sd">        or any additional data your models required</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><span class="sd">        by default cell_line_metadata_cb</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><span class="sd">    before_dense_cb : Callable[[torch.Tensor, str  |  int], torch.Tensor], optional</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="sd">        Callback to perform before densification of sparse matrix where the data at this point</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">        is still a sparse CSR Tensor, by default None</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">    after_dense_cb : Callable[[torch.Tensor, str  |  int], torch.Tensor], optional</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">        Callback to perform after densification of sparse matrix where the data at this point</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><span class="sd">        is a dense Tensor, by default None</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><span class="sd">    shuffle_strategy : ShuffleStrategy, optional</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="sd">        Strategy to split or randomize the data during the training, by default SequentialShuffleStrategy</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="sd">    runtime_env_config : dict | None, optional</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="sd">        These env config is to pass the RayTrainer processes, by default None</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="sd">    address : str | None, optional</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a><span class="sd">        Override ray address, by default None</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">    ray_trainer_strategy : Strategy | None, optional</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="sd">        Override Ray Trainer Strategy if this is None it will default to RayDDP, by default None</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">    sparse_key : str, optional</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="sd">        _description_, by default &quot;X&quot;,</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">    -------</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a><span class="sd">    RayTrainRunner</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="sd">        Use this class to start the training</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>    <span class="nd">@beartype</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="n">Model</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">],</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>        <span class="n">Ds</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">DistributedAnnDataset</span><span class="p">],</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="n">model_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>        <span class="n">metadata_cb</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">anndata</span><span class="o">.</span><span class="n">AnnData</span><span class="p">,</span> <span class="nb">dict</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_line_metadata_cb</span><span class="p">,</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>        <span class="n">before_dense_cb</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="n">after_dense_cb</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="n">shuffle_strategy</span><span class="p">:</span> <span class="n">ShuffleStrategy</span> <span class="o">=</span> <span class="n">SequentialShuffleStrategy</span><span class="p">,</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>        <span class="n">runtime_env_config</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>        <span class="n">address</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>        <span class="n">ray_trainer_strategy</span><span class="p">:</span> <span class="n">Strategy</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>        <span class="n">sparse_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>    <span class="p">):</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Model</span> <span class="o">=</span> <span class="n">Model</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Ds</span> <span class="o">=</span> <span class="n">Ds</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_keys</span> <span class="o">=</span> <span class="n">model_keys</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_cb</span> <span class="o">=</span> <span class="n">metadata_cb</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_strategy</span> <span class="o">=</span> <span class="n">shuffle_strategy</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sparse_key</span> <span class="o">=</span> <span class="n">sparse_key</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">before_dense_cb</span> <span class="o">=</span> <span class="n">before_dense_cb</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">after_dense_cb</span> <span class="o">=</span> <span class="n">after_dense_cb</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">ray_trainer_strategy</span><span class="p">:</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ray_trainer_strategy</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">lightning</span><span class="o">.</span><span class="n">RayDDPStrategy</span><span class="p">()</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ray_trainer_strategy</span> <span class="o">=</span> <span class="n">ray_trainer_strategy</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="c1"># Init ray cluster</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="n">DEFAULT_RUNTIME_ENV_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>            <span class="s2">&quot;LOG_LEVEL&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LOG_LEVEL&quot;</span><span class="p">,</span> <span class="s2">&quot;INFO&quot;</span><span class="p">),</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="p">}</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="k">if</span> <span class="n">runtime_env_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>            <span class="n">runtime_env_config</span> <span class="o">=</span> <span class="n">DEFAULT_RUNTIME_ENV_CONFIG</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>        <span class="n">ray</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>            <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">,</span> <span class="n">runtime_env</span><span class="o">=</span><span class="p">{</span><span class="o">**</span><span class="n">DEFAULT_RUNTIME_ENV_CONFIG</span><span class="p">,</span> <span class="o">**</span><span class="n">runtime_env_config</span><span class="p">},</span> <span class="n">ignore_reinit_error</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="p">)</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">cluster_resources</span><span class="p">()</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_worker_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s2">&quot;ray&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="n">Model</span><span class="p">,</span> <span class="n">Ds</span><span class="p">,</span> <span class="n">model_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_keys</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">worker_fn</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>            <span class="n">ctx</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>            <span class="k">if</span> <span class="n">ctx</span><span class="p">:</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>                <span class="n">rank</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">get_world_rank</span><span class="p">()</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>                <span class="n">rank</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>            <span class="n">indices</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;indices&quot;</span><span class="p">)</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>            <span class="n">ckpt_path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ckpt_path&quot;</span><span class="p">)</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>            <span class="n">scratch_path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scratch_path&quot;</span><span class="p">)</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>            <span class="n">scratch_content</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scratch_content&quot;</span><span class="p">)</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Verifying storage path on worker node&quot;</span><span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                <span class="n">file</span> <span class="o">=</span> <span class="n">get_fsspec</span><span class="p">(</span><span class="n">scratch_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>                <span class="n">read_content</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>                <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to access shared storage path: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">scratch_path</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot access the shared storage. Please check your storage path.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>            <span class="k">if</span> <span class="n">scratch_content</span> <span class="o">!=</span> <span class="n">read_content</span><span class="p">:</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>                    <span class="sa">f</span><span class="s2">&quot;Content mismatch detected for path: </span><span class="si">{</span><span class="n">scratch_path</span><span class="si">}</span><span class="s2">.Worker cannot read expected head node content.&quot;</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>                <span class="p">)</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Content mismatch detected. Please check your shared storage setup.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="n">num_threads</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OMP_NUM_THREADS&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()))</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=========Starting the training on </span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s2"> with num threads: </span><span class="si">{</span><span class="n">num_threads</span><span class="si">}</span><span class="s2">=========&quot;</span><span class="p">)</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>            <span class="n">model_params</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">metadata</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>            <span class="n">shuffle_strategy</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shuffle_strategy&quot;</span><span class="p">)</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>            <span class="n">ann_dm</span> <span class="o">=</span> <span class="n">AnnDataModule</span><span class="p">(</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>                <span class="n">indices</span><span class="p">,</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>                <span class="n">Ds</span><span class="p">,</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">prefetch_factor</span><span class="p">,</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sparse_key</span><span class="p">,</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>                <span class="n">shuffle_strategy</span><span class="p">,</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">before_dense_cb</span><span class="p">,</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">after_dense_cb</span><span class="p">,</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>                <span class="n">random_seed</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;random_seed&quot;</span><span class="p">],</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>            <span class="p">)</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>            <span class="k">if</span> <span class="n">model_keys</span><span class="p">:</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>                <span class="n">model_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">model_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">model_keys</span><span class="p">}</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="o">**</span><span class="n">model_params</span><span class="p">)</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>            <span class="n">trainer</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>                <span class="n">max_epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">,</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>                <span class="n">devices</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>                <span class="n">accelerator</span><span class="o">=</span><span class="n">_get_accelerator</span><span class="p">(),</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>                <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ray_trainer_strategy</span><span class="p">,</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>                <span class="n">plugins</span><span class="o">=</span><span class="p">[</span><span class="n">ray</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">lightning</span><span class="o">.</span><span class="n">RayLightningEnvironment</span><span class="p">()],</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>                <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="n">ray</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">lightning</span><span class="o">.</span><span class="n">RayTrainReportCallback</span><span class="p">()],</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>                <span class="n">enable_checkpointing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>                <span class="n">enable_progress_bar</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enable_progress_bar&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>            <span class="p">)</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>            <span class="n">trainer</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">lightning</span><span class="o">.</span><span class="n">prepare_trainer</span><span class="p">(</span><span class="n">trainer</span><span class="p">)</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;worker_mode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;inference&quot;</span><span class="p">:</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting inference mode&quot;</span><span class="p">)</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>                <span class="n">writer_cb</span> <span class="o">=</span> <span class="n">DistributedPredictionWriter</span><span class="p">(</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>                    <span class="n">output_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">result_storage_path</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;prediction_format&quot;</span><span class="p">]</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>                <span class="p">)</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>                <span class="n">trainer</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">writer_cb</span><span class="p">)</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>                <span class="n">trainer</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">ann_dm</span><span class="p">,</span> <span class="n">ckpt_path</span><span class="o">=</span><span class="n">ckpt_path</span><span class="p">)</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting training mode&quot;</span><span class="p">)</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>                <span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">ann_dm</span><span class="p">,</span> <span class="n">ckpt_path</span><span class="o">=</span><span class="n">ckpt_path</span><span class="p">)</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="k">return</span> <span class="n">worker_fn</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_setup</span><span class="p">(</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>        <span class="n">file_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="n">test_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="n">val_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="n">prefetch_factor</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>        <span class="n">max_epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>        <span class="n">thread_per_worker</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>        <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="n">result_storage_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="c1"># read more here: https://lightning.ai/docs/pytorch/stable/common/trainer.html#fit</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="n">ckpt_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>        <span class="n">is_gpu</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>        <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>        <span class="n">resource_per_worker</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>        <span class="n">is_shuffled</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="n">enable_progress_bar</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>        <span class="n">worker_mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;inference&quot;</span><span class="p">],</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>    <span class="p">):</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">result_storage_path</span> <span class="o">=</span> <span class="n">resolve_path_or_url</span><span class="p">(</span><span class="n">result_storage_path</span><span class="p">)</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prefetch_factor</span> <span class="o">=</span> <span class="n">prefetch_factor</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span> <span class="o">=</span> <span class="n">max_epochs</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">enable_progress_bar</span> <span class="o">=</span> <span class="n">enable_progress_bar</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">resource_per_worker</span><span class="p">:</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">thread_per_worker</span><span class="p">:</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting thread_per_worker to half of the available CPUs capped at 4&quot;</span><span class="p">)</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>                <span class="n">thread_per_worker</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CPU&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>            <span class="n">resource_per_worker</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;CPU&quot;</span><span class="p">:</span> <span class="n">thread_per_worker</span><span class="p">}</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>        <span class="k">if</span> <span class="n">is_gpu</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GPU&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;`is_gpu = True` but there is no GPU found. Fallback to CPU.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>            <span class="n">is_gpu</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="k">if</span> <span class="n">is_gpu</span><span class="p">:</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>            <span class="k">if</span> <span class="n">num_workers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>                <span class="n">num_workers</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GPU&quot;</span><span class="p">))</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>            <span class="n">scaling_config</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">ScalingConfig</span><span class="p">(</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>                <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">,</span> <span class="n">use_gpu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">resources_per_worker</span><span class="o">=</span><span class="n">resource_per_worker</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>            <span class="p">)</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>            <span class="n">resource_per_worker</span><span class="p">[</span><span class="s2">&quot;GPU&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>            <span class="k">if</span> <span class="n">num_workers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>                <span class="n">num_workers</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CPU&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">thread_per_worker</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>            <span class="n">scaling_config</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">ScalingConfig</span><span class="p">(</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>                <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">,</span> <span class="n">use_gpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">resources_per_worker</span><span class="o">=</span><span class="n">resource_per_worker</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>            <span class="p">)</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">num_workers</span><span class="si">}</span><span class="s2"> workers where each worker uses: </span><span class="si">{</span><span class="n">resource_per_worker</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>        <span class="n">shuffle_strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_strategy</span><span class="p">(</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>            <span class="p">[</span><span class="n">resolve_path_or_url</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">],</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>            <span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>            <span class="n">num_workers</span> <span class="o">*</span> <span class="n">thread_per_worker</span><span class="p">,</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>            <span class="n">test_size</span><span class="p">,</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>            <span class="n">val_size</span><span class="p">,</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>            <span class="n">random_seed</span><span class="p">,</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>            <span class="n">metadata_cb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_cb</span><span class="p">,</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>            <span class="n">is_shuffled</span><span class="o">=</span><span class="n">is_shuffled</span><span class="p">,</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>        <span class="p">)</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;drop_last&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;pre_fetch_then_batch&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>        <span class="n">indices</span> <span class="o">=</span> <span class="n">shuffle_strategy</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data splitting time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>        <span class="n">train_config</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>            <span class="s2">&quot;indices&quot;</span><span class="p">:</span> <span class="n">indices</span><span class="p">,</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>            <span class="s2">&quot;ckpt_path&quot;</span><span class="p">:</span> <span class="n">resolve_path_or_url</span><span class="p">(</span><span class="n">ckpt_path</span><span class="p">),</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>            <span class="s2">&quot;shuffle_strategy&quot;</span><span class="p">:</span> <span class="n">shuffle_strategy</span><span class="p">,</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="s2">&quot;enable_progress_bar&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_progress_bar</span><span class="p">,</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>            <span class="s2">&quot;scratch_path&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_storage_path</span><span class="p">,</span> <span class="s2">&quot;scratch.plt&quot;</span><span class="p">),</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>            <span class="s2">&quot;scratch_content&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>            <span class="s2">&quot;worker_mode&quot;</span><span class="p">:</span> <span class="n">worker_mode</span><span class="p">,</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>            <span class="s2">&quot;random_seed&quot;</span><span class="p">:</span> <span class="n">random_seed</span><span class="p">,</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>        <span class="p">}</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>        <span class="k">if</span> <span class="n">worker_mode</span> <span class="o">==</span> <span class="s2">&quot;inference&quot;</span><span class="p">:</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>            <span class="n">train_config</span><span class="p">[</span><span class="s2">&quot;prediction_format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;prediction_format&quot;</span><span class="p">]</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>        <span class="n">par_trainer</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">torch</span><span class="o">.</span><span class="n">TorchTrainer</span><span class="p">(</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_worker_fn</span><span class="p">(),</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>            <span class="n">scaling_config</span><span class="o">=</span><span class="n">scaling_config</span><span class="p">,</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>            <span class="n">train_loop_config</span><span class="o">=</span><span class="n">train_config</span><span class="p">,</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>            <span class="n">run_config</span><span class="o">=</span><span class="n">ray</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">RunConfig</span><span class="p">(</span><span class="n">storage_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">result_storage_path</span><span class="p">),</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>        <span class="p">)</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Writing scratch content to share storage&quot;</span><span class="p">)</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>        <span class="n">scratch_path</span> <span class="o">=</span> <span class="n">train_config</span><span class="p">[</span><span class="s2">&quot;scratch_path&quot;</span><span class="p">]</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>        <span class="n">fs</span><span class="p">,</span> <span class="n">path_on_fs</span> <span class="o">=</span> <span class="n">fsspec</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">url_to_fs</span><span class="p">(</span><span class="n">scratch_path</span><span class="p">)</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>        <span class="n">parent_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path_on_fs</span><span class="p">)</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">fs</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">):</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ensuring directory exists: </span><span class="si">{</span><span class="n">parent_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>            <span class="n">fs</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>        <span class="n">file</span> <span class="o">=</span> <span class="n">get_fsspec</span><span class="p">(</span><span class="n">scratch_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">train_config</span><span class="p">[</span><span class="s2">&quot;scratch_content&quot;</span><span class="p">])</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Spawning Ray worker and initiating distributed training&quot;</span><span class="p">)</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>        <span class="k">return</span> <span class="n">par_trainer</span><span class="p">,</span> <span class="n">indices</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>    <span class="nd">@beartype</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">par_inference</span><span class="p">(</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>        <span class="n">file_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>        <span class="n">ckpt_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>        <span class="n">result_storage_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;~/protoplast_results&quot;</span><span class="p">,</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>        <span class="n">prefetch_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>        <span class="n">thread_per_worker</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>        <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>        <span class="n">is_gpu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>        <span class="n">resource_per_worker</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>        <span class="n">enable_progress_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>        <span class="n">prediction_format</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="s2">&quot;parquet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span><span class="p">,</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>    <span class="p">):</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Start parallel inference the order of the result is not guaranteed to be the same as input file</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a><span class="sd">        file_paths : list[str]</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a><span class="sd">            List of h5ad AnnData files</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a><span class="sd">        batch_size : int, optional</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a><span class="sd">            How much data to fetch from disk, by default to 2000</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a><span class="sd">        prefetch_factor : int, optional</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a><span class="sd">            Total data fetch is prefetch_factor * batch_size, by default 4</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a><span class="sd">        thread_per_worker : int | None, optional</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a><span class="sd">            Amount of worker for each dataloader, by default None</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a><span class="sd">        num_workers : int | None, optional</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a><span class="sd">            Override number of Ray processes default to number of GPU(s) in the cluster, by default None</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a><span class="sd">        is_gpu : bool, optional</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a><span class="sd">            By default True turn this off if your system don&#39;t have any GPU, by default True</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a><span class="sd">        resource_per_worker : dict | None, optional</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a><span class="sd">            This get pass to Ray you can specify how much CPU or GPU each Ray process get, by default None</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a><span class="sd">        ckpt_path: str | None = None,</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a><span class="sd">            Path of the checkpoint if this is specified it will train from checkpoint otherwise it will start the</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a><span class="sd">            training from scratch, by default None</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a><span class="sd">        enable_progress_bar : bool</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a><span class="sd">            Whether to enable Trainer progress bar or not, by default True</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a><span class="sd">        -------</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a><span class="sd">        Result</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a><span class="sd">            The inference result from RayTrainer</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>        <span class="n">par_trainer</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>            <span class="n">file_paths</span><span class="p">,</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>            <span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>            <span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>            <span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>            <span class="n">prefetch_factor</span><span class="p">,</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>            <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>            <span class="n">thread_per_worker</span><span class="p">,</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>            <span class="n">num_workers</span><span class="p">,</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>            <span class="n">result_storage_path</span><span class="p">,</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>            <span class="n">ckpt_path</span><span class="p">,</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>            <span class="n">is_gpu</span><span class="p">,</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>            <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>            <span class="n">resource_per_worker</span><span class="p">,</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>            <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>            <span class="n">enable_progress_bar</span><span class="p">,</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>            <span class="n">prediction_format</span><span class="o">=</span><span class="n">prediction_format</span><span class="p">,</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>            <span class="n">worker_mode</span><span class="o">=</span><span class="s2">&quot;inference&quot;</span><span class="p">,</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>        <span class="p">)</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>        <span class="c1"># despite the confusing name we use fit to run inference here</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">par_trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>        <span class="c1"># combine the result and order it correctly</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">inference</span><span class="p">(</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>        <span class="n">file_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>        <span class="n">result_storage_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>        <span class="n">ckpt_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>        <span class="n">prediction_format</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="s2">&quot;parquet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span><span class="p">,</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>        <span class="n">enable_progress_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>        <span class="n">batch_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>    <span class="p">):</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Start inference in a single process order is guarantee to be the same as input file</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a><span class="sd">        don&#39;t use this in a distributed cluster</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="sd">        file_paths : list[str]</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a><span class="sd">            List of h5ad AnnData files</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a><span class="sd">        result_storage_path : str</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a><span class="sd">            Path to store the prediction result</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a><span class="sd">        ckpt_path : str</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a><span class="sd">            Path of the checkpoint to run inference</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a><span class="sd">        enable_progress_bar : bool, optional</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a><span class="sd">            Whether to enable Trainer progress bar or not, by default True</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a><span class="sd">        batch_size : int, optional</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a><span class="sd">            How much data to fetch from disk, by default to 2000</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;darwin&quot;</span><span class="p">,</span> <span class="s2">&quot;win32&quot;</span><span class="p">):</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>            <span class="n">override_thread</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>            <span class="n">override_thread</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>        <span class="n">shuffle_strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_strategy</span><span class="p">(</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>            <span class="p">[</span><span class="n">resolve_path_or_url</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">],</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>            <span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>            <span class="n">override_thread</span><span class="p">,</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>            <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>            <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>            <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>            <span class="n">metadata_cb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_cb</span><span class="p">,</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>            <span class="n">is_shuffled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>            <span class="n">prediction_format</span><span class="o">=</span><span class="n">prediction_format</span><span class="p">,</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>        <span class="p">)</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>        <span class="n">indices</span> <span class="o">=</span> <span class="n">shuffle_strategy</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>        <span class="n">writer_cb</span> <span class="o">=</span> <span class="n">PredictionWriterCallback</span><span class="p">(</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>            <span class="n">output_path</span><span class="o">=</span><span class="n">resolve_path_or_url</span><span class="p">(</span><span class="n">result_storage_path</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="n">prediction_format</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>        <span class="p">)</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>        <span class="n">trainer</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>            <span class="n">devices</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>            <span class="n">accelerator</span><span class="o">=</span><span class="n">_get_accelerator</span><span class="p">(),</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>            <span class="n">enable_progress_bar</span><span class="o">=</span><span class="n">enable_progress_bar</span><span class="p">,</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>        <span class="p">)</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>        <span class="n">trainer</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">writer_cb</span><span class="p">)</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>        <span class="n">ann_dm</span> <span class="o">=</span> <span class="n">AnnDataModule</span><span class="p">(</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>            <span class="n">indices</span><span class="p">,</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">Ds</span><span class="p">,</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>            <span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sparse_key</span><span class="p">,</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>            <span class="n">SequentialShuffleStrategy</span><span class="p">,</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">before_dense_cb</span><span class="p">,</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">after_dense_cb</span><span class="p">,</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>            <span class="n">override_thread</span><span class="o">=</span><span class="n">override_thread</span><span class="p">,</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>        <span class="p">)</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>        <span class="n">model_params</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">metadata</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_keys</span><span class="p">:</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>            <span class="n">model_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">model_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_keys</span><span class="p">}</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="o">**</span><span class="n">model_params</span><span class="p">)</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>        <span class="n">trainer</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">ann_dm</span><span class="p">,</span> <span class="n">ckpt_path</span><span class="o">=</span><span class="n">resolve_path_or_url</span><span class="p">(</span><span class="n">ckpt_path</span><span class="p">))</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>    <span class="nd">@beartype</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>        <span class="n">file_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>        <span class="n">test_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>        <span class="n">val_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>        <span class="n">prefetch_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>        <span class="n">max_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>        <span class="n">thread_per_worker</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>        <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>        <span class="n">result_storage_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;~/protoplast_results&quot;</span><span class="p">,</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>        <span class="c1"># read more here: https://lightning.ai/docs/pytorch/stable/common/trainer.html#fit</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>        <span class="n">ckpt_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>        <span class="n">is_gpu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>        <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>        <span class="n">resource_per_worker</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>        <span class="n">is_shuffled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>        <span class="n">enable_progress_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>    <span class="p">):</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Start the training</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a><span class="sd">        file_paths : list[str]</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a><span class="sd">            List of h5ad AnnData files</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a><span class="sd">        batch_size : int, optional</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a><span class="sd">            How much data to fetch from disk, by default to 2000</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a><span class="sd">        test_size : float, optional</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a><span class="sd">            Fraction of test data for example 0.1 means 10% will be split for testing</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a><span class="sd">            default to 0.0</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a><span class="sd">        val_size : float, optional</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a><span class="sd">            Fraction of validation data for example 0.2 means 20% will be split for validation,</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a><span class="sd">            default to 0.2</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a><span class="sd">        prefetch_factor : int, optional</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a><span class="sd">            Total data fetch is prefetch_factor * batch_size, by default 4</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a><span class="sd">        max_epochs : int, optional</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a><span class="sd">            How many epoch(s) to train with, by default 1</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a><span class="sd">        thread_per_worker : int | None, optional</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a><span class="sd">            Amount of worker for each dataloader, by default None</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a><span class="sd">        num_workers : int | None, optional</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a><span class="sd">            Override number of Ray processes default to number of GPU(s) in the cluster, by default None</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a><span class="sd">        result_storage_path : str, optional</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a><span class="sd">            Path to store the loss, validation and checkpoint, by default &quot;~/protoplast_results&quot;</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a><span class="sd">        ckpt_path : str | None, optional</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a><span class="sd">            Path of the checkpoint if this is specified it will train from checkpoint otherwise it will start the</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a><span class="sd">            training from scratch, by default None</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a><span class="sd">        is_gpu : bool, optional</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a><span class="sd">            By default True turn this off if your system don&#39;t have any GPU, by default True</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a><span class="sd">        random_seed : int | None, optional</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a><span class="sd">            Set this to None for real training but for benchmarking and result replication</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a><span class="sd">            you can adjust the seed here, by default 42</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a><span class="sd">        resource_per_worker : dict | None, optional</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a><span class="sd">            This get pass to Ray you can specify how much CPU or GPU each Ray process get, by default None</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a><span class="sd">        enable_progress_bar : bool</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a><span class="sd">            Whether to enable Trainer progress bar or not, by default True</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a><span class="sd">        -------</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a><span class="sd">        Result</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a><span class="sd">            The training result from RayTrainer</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>        <span class="n">par_trainer</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>            <span class="n">file_paths</span><span class="p">,</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>            <span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>            <span class="n">test_size</span><span class="p">,</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>            <span class="n">val_size</span><span class="p">,</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>            <span class="n">prefetch_factor</span><span class="p">,</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>            <span class="n">max_epochs</span><span class="p">,</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>            <span class="n">thread_per_worker</span><span class="p">,</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>            <span class="n">num_workers</span><span class="p">,</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>            <span class="n">result_storage_path</span><span class="p">,</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>            <span class="n">ckpt_path</span><span class="p">,</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>            <span class="n">is_gpu</span><span class="p">,</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>            <span class="n">random_seed</span><span class="p">,</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>            <span class="n">resource_per_worker</span><span class="p">,</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>            <span class="n">is_shuffled</span><span class="p">,</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>            <span class="n">enable_progress_bar</span><span class="p">,</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>            <span class="n">worker_mode</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">,</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>        <span class="p">)</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>        <span class="k">return</span> <span class="n">par_trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="protoplast.scrna.anndata.trainer.RayTrainRunner.inference" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">inference</span><span class="p">(</span><span class="n">file_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">result_storage_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ckpt_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prediction_format</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="s1">&#39;parquet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="n">enable_progress_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span></code>

<a href="#protoplast.scrna.anndata.trainer.RayTrainRunner.inference" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Start inference in a single process order is guarantee to be the same as input file
don't use this in a distributed cluster</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>file_paths</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of h5ad AnnData files</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>result_storage_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to store the prediction result</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ckpt_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path of the checkpoint to run inference</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>enable_progress_bar</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to enable Trainer progress bar or not, by default True</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How much data to fetch from disk, by default to 2000</p>
              </div>
            </td>
            <td>
                  <code>2000</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/protoplast/scrna/anndata/trainer.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-430" name="__codelineno-0-430"></a><span class="k">def</span><span class="w"> </span><span class="nf">inference</span><span class="p">(</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>    <span class="n">file_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>    <span class="n">result_storage_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>    <span class="n">ckpt_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>    <span class="n">prediction_format</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="s2">&quot;parquet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span><span class="p">,</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>    <span class="n">enable_progress_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>    <span class="n">batch_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a><span class="p">):</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Start inference in a single process order is guarantee to be the same as input file</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a><span class="sd">    don&#39;t use this in a distributed cluster</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="sd">    file_paths : list[str]</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a><span class="sd">        List of h5ad AnnData files</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a><span class="sd">    result_storage_path : str</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a><span class="sd">        Path to store the prediction result</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a><span class="sd">    ckpt_path : str</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a><span class="sd">        Path of the checkpoint to run inference</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a><span class="sd">    enable_progress_bar : bool, optional</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a><span class="sd">        Whether to enable Trainer progress bar or not, by default True</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a><span class="sd">    batch_size : int, optional</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a><span class="sd">        How much data to fetch from disk, by default to 2000</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;darwin&quot;</span><span class="p">,</span> <span class="s2">&quot;win32&quot;</span><span class="p">):</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>        <span class="n">override_thread</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>        <span class="n">override_thread</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>    <span class="n">shuffle_strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_strategy</span><span class="p">(</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>        <span class="p">[</span><span class="n">resolve_path_or_url</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">],</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>        <span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>        <span class="n">override_thread</span><span class="p">,</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>        <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>        <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>        <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>        <span class="n">metadata_cb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_cb</span><span class="p">,</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>        <span class="n">is_shuffled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>        <span class="n">prediction_format</span><span class="o">=</span><span class="n">prediction_format</span><span class="p">,</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>    <span class="p">)</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>    <span class="n">indices</span> <span class="o">=</span> <span class="n">shuffle_strategy</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>    <span class="n">writer_cb</span> <span class="o">=</span> <span class="n">PredictionWriterCallback</span><span class="p">(</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>        <span class="n">output_path</span><span class="o">=</span><span class="n">resolve_path_or_url</span><span class="p">(</span><span class="n">result_storage_path</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="n">prediction_format</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>    <span class="p">)</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>    <span class="n">trainer</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>        <span class="n">devices</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>        <span class="n">accelerator</span><span class="o">=</span><span class="n">_get_accelerator</span><span class="p">(),</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>        <span class="n">enable_progress_bar</span><span class="o">=</span><span class="n">enable_progress_bar</span><span class="p">,</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>    <span class="p">)</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>    <span class="n">trainer</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">writer_cb</span><span class="p">)</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>    <span class="n">ann_dm</span> <span class="o">=</span> <span class="n">AnnDataModule</span><span class="p">(</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>        <span class="n">indices</span><span class="p">,</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">Ds</span><span class="p">,</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>        <span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sparse_key</span><span class="p">,</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>        <span class="n">SequentialShuffleStrategy</span><span class="p">,</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">before_dense_cb</span><span class="p">,</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">after_dense_cb</span><span class="p">,</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>        <span class="n">override_thread</span><span class="o">=</span><span class="n">override_thread</span><span class="p">,</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>    <span class="p">)</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>    <span class="n">model_params</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">metadata</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_keys</span><span class="p">:</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>        <span class="n">model_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">model_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_keys</span><span class="p">}</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>    <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="o">**</span><span class="n">model_params</span><span class="p">)</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>    <span class="n">trainer</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">datamodule</span><span class="o">=</span><span class="n">ann_dm</span><span class="p">,</span> <span class="n">ckpt_path</span><span class="o">=</span><span class="n">resolve_path_or_url</span><span class="p">(</span><span class="n">ckpt_path</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="protoplast.scrna.anndata.trainer.RayTrainRunner.par_inference" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">par_inference</span><span class="p">(</span><span class="n">file_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ckpt_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">result_storage_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;~/protoplast_results&#39;</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span> <span class="n">prefetch_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">thread_per_worker</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">is_gpu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">resource_per_worker</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">enable_progress_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">prediction_format</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="s1">&#39;parquet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#protoplast.scrna.anndata.trainer.RayTrainRunner.par_inference" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Start parallel inference the order of the result is not guaranteed to be the same as input file</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>file_paths</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of h5ad AnnData files</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How much data to fetch from disk, by default to 2000</p>
              </div>
            </td>
            <td>
                  <code>2000</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prefetch_factor</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Total data fetch is prefetch_factor * batch_size, by default 4</p>
              </div>
            </td>
            <td>
                  <code>4</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>thread_per_worker</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Amount of worker for each dataloader, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_workers</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Override number of Ray processes default to number of GPU(s) in the cluster, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>is_gpu</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>By default True turn this off if your system don't have any GPU, by default True</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resource_per_worker</code>
            </td>
            <td>
                  <code><span title="dict">dict</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>This get pass to Ray you can specify how much CPU or GPU each Ray process get, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ckpt_path</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path of the checkpoint if this is specified it will train from checkpoint otherwise it will start the
training from scratch, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>enable_progress_bar</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to enable Trainer progress bar or not, by default True</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The inference result from RayTrainer</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/protoplast/scrna/anndata/trainer.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-361" name="__codelineno-0-361"></a><span class="nd">@beartype</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a><span class="k">def</span><span class="w"> </span><span class="nf">par_inference</span><span class="p">(</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>    <span class="n">file_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>    <span class="n">ckpt_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>    <span class="n">result_storage_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;~/protoplast_results&quot;</span><span class="p">,</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>    <span class="n">prefetch_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>    <span class="n">thread_per_worker</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>    <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>    <span class="n">is_gpu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>    <span class="n">resource_per_worker</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>    <span class="n">enable_progress_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>    <span class="n">prediction_format</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="s2">&quot;parquet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;csv&quot;</span><span class="p">,</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a><span class="p">):</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Start parallel inference the order of the result is not guaranteed to be the same as input file</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a><span class="sd">    file_paths : list[str]</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a><span class="sd">        List of h5ad AnnData files</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a><span class="sd">    batch_size : int, optional</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a><span class="sd">        How much data to fetch from disk, by default to 2000</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a><span class="sd">    prefetch_factor : int, optional</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a><span class="sd">        Total data fetch is prefetch_factor * batch_size, by default 4</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a><span class="sd">    thread_per_worker : int | None, optional</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a><span class="sd">        Amount of worker for each dataloader, by default None</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a><span class="sd">    num_workers : int | None, optional</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a><span class="sd">        Override number of Ray processes default to number of GPU(s) in the cluster, by default None</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a><span class="sd">    is_gpu : bool, optional</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a><span class="sd">        By default True turn this off if your system don&#39;t have any GPU, by default True</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a><span class="sd">    resource_per_worker : dict | None, optional</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a><span class="sd">        This get pass to Ray you can specify how much CPU or GPU each Ray process get, by default None</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a><span class="sd">    ckpt_path: str | None = None,</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a><span class="sd">        Path of the checkpoint if this is specified it will train from checkpoint otherwise it will start the</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a><span class="sd">        training from scratch, by default None</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a><span class="sd">    enable_progress_bar : bool</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a><span class="sd">        Whether to enable Trainer progress bar or not, by default True</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a><span class="sd">    -------</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a><span class="sd">    Result</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a><span class="sd">        The inference result from RayTrainer</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>    <span class="n">par_trainer</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>        <span class="n">file_paths</span><span class="p">,</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>        <span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>        <span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>        <span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>        <span class="n">prefetch_factor</span><span class="p">,</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>        <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>        <span class="n">thread_per_worker</span><span class="p">,</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>        <span class="n">num_workers</span><span class="p">,</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>        <span class="n">result_storage_path</span><span class="p">,</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>        <span class="n">ckpt_path</span><span class="p">,</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>        <span class="n">is_gpu</span><span class="p">,</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>        <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>        <span class="n">resource_per_worker</span><span class="p">,</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>        <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>        <span class="n">enable_progress_bar</span><span class="p">,</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>        <span class="n">prediction_format</span><span class="o">=</span><span class="n">prediction_format</span><span class="p">,</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>        <span class="n">worker_mode</span><span class="o">=</span><span class="s2">&quot;inference&quot;</span><span class="p">,</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>    <span class="p">)</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>    <span class="c1"># despite the confusing name we use fit to run inference here</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">par_trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>    <span class="c1"># combine the result and order it correctly</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="protoplast.scrna.anndata.trainer.RayTrainRunner.train" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">train</span><span class="p">(</span><span class="n">file_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span> <span class="n">test_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">val_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">prefetch_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">max_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">thread_per_worker</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">result_storage_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;~/protoplast_results&#39;</span><span class="p">,</span> <span class="n">ckpt_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">is_gpu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span> <span class="n">resource_per_worker</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">is_shuffled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">enable_progress_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#protoplast.scrna.anndata.trainer.RayTrainRunner.train" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Start the training</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>file_paths</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of h5ad AnnData files</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How much data to fetch from disk, by default to 2000</p>
              </div>
            </td>
            <td>
                  <code>2000</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>test_size</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fraction of test data for example 0.1 means 10% will be split for testing
default to 0.0</p>
              </div>
            </td>
            <td>
                  <code>0.0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>val_size</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fraction of validation data for example 0.2 means 20% will be split for validation,
default to 0.2</p>
              </div>
            </td>
            <td>
                  <code>0.2</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prefetch_factor</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Total data fetch is prefetch_factor * batch_size, by default 4</p>
              </div>
            </td>
            <td>
                  <code>4</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_epochs</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How many epoch(s) to train with, by default 1</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>thread_per_worker</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Amount of worker for each dataloader, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_workers</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Override number of Ray processes default to number of GPU(s) in the cluster, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>result_storage_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to store the loss, validation and checkpoint, by default "~/protoplast_results"</p>
              </div>
            </td>
            <td>
                  <code>&#39;~/protoplast_results&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ckpt_path</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path of the checkpoint if this is specified it will train from checkpoint otherwise it will start the
training from scratch, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>is_gpu</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>By default True turn this off if your system don't have any GPU, by default True</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>random_seed</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Set this to None for real training but for benchmarking and result replication
you can adjust the seed here, by default 42</p>
              </div>
            </td>
            <td>
                  <code>42</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resource_per_worker</code>
            </td>
            <td>
                  <code><span title="dict">dict</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>This get pass to Ray you can specify how much CPU or GPU each Ray process get, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>enable_progress_bar</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to enable Trainer progress bar or not, by default True</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Result">Result</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The training result from RayTrainer</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/protoplast/scrna/anndata/trainer.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-497" name="__codelineno-0-497"></a><span class="nd">@beartype</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a><span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>    <span class="n">file_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>    <span class="n">test_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>    <span class="n">val_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>    <span class="n">prefetch_factor</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>    <span class="n">max_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>    <span class="n">thread_per_worker</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>    <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>    <span class="n">result_storage_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;~/protoplast_results&quot;</span><span class="p">,</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>    <span class="c1"># read more here: https://lightning.ai/docs/pytorch/stable/common/trainer.html#fit</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>    <span class="n">ckpt_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>    <span class="n">is_gpu</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>    <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>    <span class="n">resource_per_worker</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>    <span class="n">is_shuffled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>    <span class="n">enable_progress_bar</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a><span class="p">):</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Start the training</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a><span class="sd">    file_paths : list[str]</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a><span class="sd">        List of h5ad AnnData files</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a><span class="sd">    batch_size : int, optional</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a><span class="sd">        How much data to fetch from disk, by default to 2000</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a><span class="sd">    test_size : float, optional</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a><span class="sd">        Fraction of test data for example 0.1 means 10% will be split for testing</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a><span class="sd">        default to 0.0</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a><span class="sd">    val_size : float, optional</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a><span class="sd">        Fraction of validation data for example 0.2 means 20% will be split for validation,</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a><span class="sd">        default to 0.2</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a><span class="sd">    prefetch_factor : int, optional</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a><span class="sd">        Total data fetch is prefetch_factor * batch_size, by default 4</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a><span class="sd">    max_epochs : int, optional</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a><span class="sd">        How many epoch(s) to train with, by default 1</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a><span class="sd">    thread_per_worker : int | None, optional</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a><span class="sd">        Amount of worker for each dataloader, by default None</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a><span class="sd">    num_workers : int | None, optional</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a><span class="sd">        Override number of Ray processes default to number of GPU(s) in the cluster, by default None</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a><span class="sd">    result_storage_path : str, optional</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a><span class="sd">        Path to store the loss, validation and checkpoint, by default &quot;~/protoplast_results&quot;</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a><span class="sd">    ckpt_path : str | None, optional</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a><span class="sd">        Path of the checkpoint if this is specified it will train from checkpoint otherwise it will start the</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a><span class="sd">        training from scratch, by default None</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a><span class="sd">    is_gpu : bool, optional</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a><span class="sd">        By default True turn this off if your system don&#39;t have any GPU, by default True</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a><span class="sd">    random_seed : int | None, optional</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a><span class="sd">        Set this to None for real training but for benchmarking and result replication</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a><span class="sd">        you can adjust the seed here, by default 42</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a><span class="sd">    resource_per_worker : dict | None, optional</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a><span class="sd">        This get pass to Ray you can specify how much CPU or GPU each Ray process get, by default None</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a><span class="sd">    enable_progress_bar : bool</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a><span class="sd">        Whether to enable Trainer progress bar or not, by default True</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a><span class="sd">    -------</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a><span class="sd">    Result</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a><span class="sd">        The training result from RayTrainer</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>    <span class="n">par_trainer</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>        <span class="n">file_paths</span><span class="p">,</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>        <span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>        <span class="n">test_size</span><span class="p">,</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>        <span class="n">val_size</span><span class="p">,</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>        <span class="n">prefetch_factor</span><span class="p">,</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>        <span class="n">max_epochs</span><span class="p">,</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>        <span class="n">thread_per_worker</span><span class="p">,</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>        <span class="n">num_workers</span><span class="p">,</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>        <span class="n">result_storage_path</span><span class="p">,</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>        <span class="n">ckpt_path</span><span class="p">,</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>        <span class="n">is_gpu</span><span class="p">,</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>        <span class="n">random_seed</span><span class="p">,</span>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>        <span class="n">resource_per_worker</span><span class="p">,</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>        <span class="n">is_shuffled</span><span class="p">,</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>        <span class="n">enable_progress_bar</span><span class="p">,</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>        <span class="n">worker_mode</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">,</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>    <span class="p">)</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>    <span class="k">return</span> <span class="n">par_trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="datamodule">DataModule<a class="headerlink" href="#datamodule" title="Permanent link">&para;</a></h2>
<p>Wrapper around Dataset on how the data should be forward to the Lightning Model support hooks at various
Lifecycle when the data get pass to the model</p>


<div class="doc doc-object doc-class">



<h2 id="protoplast.scrna.anndata.torch_dataloader.AnnDataModule" class="doc doc-heading">
            <code>protoplast.scrna.anndata.torch_dataloader.AnnDataModule</code>


<a href="#protoplast.scrna.anndata.torch_dataloader.AnnDataModule" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="lightning.pytorch.LightningDataModule">LightningDataModule</span></code></p>









              <details class="quote">
                <summary>Source code in <code>src/protoplast/scrna/anndata/torch_dataloader.py</code></summary>
                <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-394" name="__codelineno-0-394"></a><span class="k">class</span><span class="w"> </span><span class="nc">AnnDataModule</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">LightningDataModule</span><span class="p">):</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>        <span class="n">indices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>        <span class="n">dataset</span><span class="p">:</span> <span class="n">DistributedAnnDataset</span><span class="p">,</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>        <span class="n">prefetch_factor</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>        <span class="n">sparse_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>        <span class="n">shuffle_strategy</span><span class="p">:</span> <span class="n">ShuffleStrategy</span><span class="p">,</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>        <span class="n">before_dense_cb</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>        <span class="n">after_dense_cb</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span><span class="p">],</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>        <span class="n">override_thread</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>    <span class="p">):</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>        <span class="k">if</span> <span class="n">override_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>            <span class="n">num_threads</span> <span class="o">=</span> <span class="n">override_thread</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>            <span class="n">num_threads</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;OMP_NUM_THREADS&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()))</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loader_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>            <span class="n">num_workers</span><span class="o">=</span><span class="n">num_threads</span><span class="p">,</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>        <span class="p">)</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>        <span class="k">if</span> <span class="n">num_threads</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loader_config</span><span class="p">[</span><span class="s2">&quot;prefetch_factor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefetch_factor</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loader_config</span><span class="p">[</span><span class="s2">&quot;persistent_workers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>        <span class="k">if</span> <span class="n">shuffle_strategy</span><span class="o">.</span><span class="n">is_mixer</span><span class="p">():</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loader_config</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shuffle_strategy</span><span class="o">.</span><span class="n">mini_batch_size</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loader_config</span><span class="p">[</span><span class="s2">&quot;collate_fn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shuffle_strategy</span><span class="o">.</span><span class="n">mixer</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loader_config</span><span class="p">[</span><span class="s2">&quot;drop_last&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">loader_config</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sparse_key</span> <span class="o">=</span> <span class="n">sparse_key</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">before_dense_cb</span> <span class="o">=</span> <span class="n">before_dense_cb</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">after_dense_cb</span> <span class="o">=</span> <span class="n">after_dense_cb</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">):</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>        <span class="c1"># this is not necessary but it is here in case we want to download data to local node in the future</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>        <span class="k">if</span> <span class="n">stage</span> <span class="o">==</span> <span class="s2">&quot;fit&quot;</span><span class="p">:</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">train_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">create_distributed_ds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_key</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">create_distributed_ds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_key</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>        <span class="k">if</span> <span class="n">stage</span> <span class="o">==</span> <span class="s2">&quot;test&quot;</span><span class="p">:</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">val_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">create_distributed_ds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_key</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>        <span class="k">if</span> <span class="n">stage</span> <span class="o">==</span> <span class="s2">&quot;predict&quot;</span><span class="p">:</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">predict_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">create_distributed_ds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_key</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">train_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_ds</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">loader_config</span><span class="p">)</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">val_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_ds</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">loader_config</span><span class="p">)</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">test_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>        <span class="c1"># for now not support testing for splitting will support it soon in the future</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_ds</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">loader_config</span><span class="p">)</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">predict_dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_ds</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">loader_config</span><span class="p">)</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">densify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">before_dense_cb</span><span class="p">:</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">before_dense_cb</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">is_sparse</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">is_sparse_csr</span><span class="p">:</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">to_dense</span><span class="p">()</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">after_dense_cb</span><span class="p">:</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">after_dense_cb</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>        <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">on_after_batch_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">dataloader_idx</span><span class="p">):</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">):</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">densify</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch</span><span class="p">)]</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>            <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">densify</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">densify</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>            <span class="k">return</span> <span class="n">batch</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div><h2 id="dataset">Dataset<a class="headerlink" href="#dataset" title="Permanent link">&para;</a></h2>
<p>For fetching and sending data to the model
</p>


<div class="doc doc-object doc-class">



<h2 id="protoplast.scrna.anndata.torch_dataloader.DistributedAnnDataset" class="doc doc-heading">
            <code>protoplast.scrna.anndata.torch_dataloader.DistributedAnnDataset</code>


<a href="#protoplast.scrna.anndata.torch_dataloader.DistributedAnnDataset" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="torch.utils.data.IterableDataset">IterableDataset</span></code></p>


        <p>Dataset that support multiworker distribution this version will yield the data
in a sequential manner</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>file_paths</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of files</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>indices</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="list">list</span>[<span title="int">int</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of indices from <code>SplitInfo</code></p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>metadata</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Metadata dictionary for sending data to the model or other logical purposes</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sparse_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>AnnData key for the sparse matrix usually it is "X" if "layers" please use the dot notation for example
"layers.attr" where attr is the key in the layer you want to refer to</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mini_batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How many observation to send to the model must be less than <code>batch_size</code>, by default None
and will send the whole batch if this is not specified</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/protoplast/scrna/anndata/torch_dataloader.py</code></summary>
                <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="k">class</span><span class="w"> </span><span class="nc">DistributedAnnDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">IterableDataset</span><span class="p">):</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Dataset that support multiworker distribution this version will yield the data</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">    in a sequential manner</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">    file_paths : list[str]</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">        List of files</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">    indices : list[list[int]]</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">        List of indices from `SplitInfo`</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">    metadata : dict</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">        Metadata dictionary for sending data to the model or other logical purposes</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">    sparse_key : str</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">        AnnData key for the sparse matrix usually it is &quot;X&quot; if &quot;layers&quot; please use the dot notation for example</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">        &quot;layers.attr&quot; where attr is the key in the layer you want to refer to</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    mini_batch_size : int, optional</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">        How many observation to send to the model must be less than `batch_size`, by default None</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">        and will send the whole batch if this is not specified</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="n">file_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="n">indices</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="n">sparse_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="n">mini_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>  <span class="c1"># FIXME: workaround for PROTO-23</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="p">):</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="c1"># use first file as reference first</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">file_paths</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sparse_key</span> <span class="o">=</span> <span class="n">sparse_key</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ad</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="c1"># map each gene to an index</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batches</span> <span class="o">=</span> <span class="n">indices</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_size</span> <span class="o">=</span> <span class="n">mini_batch_size</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="k">if</span> <span class="s2">&quot;random_seed&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;random_seed&quot;</span><span class="p">]</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="nd">@classmethod</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_distributed_ds</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">indices</span><span class="p">:</span> <span class="n">SplitInfo</span><span class="p">,</span> <span class="n">sparse_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">SplitInfo</span><span class="p">)</span> <span class="k">else</span> <span class="n">indices</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="n">indices</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">],</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="n">indices</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">_indices&quot;</span><span class="p">],</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="n">indices</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">],</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="n">sparse_key</span><span class="p">,</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="n">mini_batch_size</span><span class="o">=</span><span class="n">indices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mini_batch_size&quot;</span><span class="p">),</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="p">)</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_init_rank</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="n">worker_info</span> <span class="o">=</span> <span class="n">get_worker_info</span><span class="p">()</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="k">if</span> <span class="n">worker_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wid</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nworkers</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wid</span> <span class="o">=</span> <span class="n">worker_info</span><span class="o">.</span><span class="n">id</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">nworkers</span> <span class="o">=</span> <span class="n">worker_info</span><span class="o">.</span><span class="n">num_workers</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="n">w_rank</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">get_rank</span><span class="p">()</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="n">w_size</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">get_world_size</span><span class="p">()</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>            <span class="n">w_rank</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>            <span class="n">w_size</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="k">if</span> <span class="n">w_rank</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ray_rank</span> <span class="o">=</span> <span class="n">w_rank</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ray_size</span> <span class="o">=</span> <span class="n">w_size</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ray_rank</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ray_size</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">global_rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ray_rank</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nworkers</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">wid</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">total_workers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ray_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nworkers</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_sparse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">mat</span><span class="p">):</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sparse_csr_tensor</span><span class="p">(</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">indptr</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">(),</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">(),</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">(),</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                <span class="n">mat</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>            <span class="p">)</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_mat_by_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ad</span><span class="p">:</span> <span class="n">anndata</span><span class="o">.</span><span class="n">AnnData</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sp</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">:</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_key</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span><span class="p">:</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>            <span class="k">return</span> <span class="n">ad</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="k">elif</span> <span class="s2">&quot;layers&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_key</span><span class="p">:</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>            <span class="n">_</span><span class="p">,</span> <span class="n">attr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>            <span class="k">return</span> <span class="n">ad</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Sparse key not supported&quot;</span><span class="p">)</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The subclass should implement the logic to get more data for the cell. It can leverage this super function</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">        to efficiently get X as a sparse tensor. An example of how to get to more data from the cell is</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">        `self.ad.obs[&quot;key&quot;][start:end]` where you must only fetch a subset of this data with `start` and `end`</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">        Parameters</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">        ----------</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">        start : int</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">            Starting index of this batch</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">        end : int</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">            Ending index of this batch</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">        Returns</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">        -------</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">        Any</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">            Usually a tensor, a list of tensor or dictionary with tensor value</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="c1"># by default we just return the matrix</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="c1"># sometimes, the h5ad file stores X as the dense matrix,</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="c1"># so we have to make sure it is a sparse matrix before returning</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="c1"># the batch item</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>            <span class="c1"># we don&#39;t have the X upstream, so we have to incurr IO to fetch it</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mat_by_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_sparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="k">return</span> <span class="n">X</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>            <span class="n">world_size</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">get_world_size</span><span class="p">()</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not using tdd default to world size 1&quot;</span><span class="p">)</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>            <span class="n">world_size</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_size</span><span class="p">:</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>            <span class="n">total_sample</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">))</span> <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">total_sample</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_size</span> <span class="o">/</span> <span class="n">world_size</span><span class="p">)</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">world_size</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_init_rank</span><span class="p">()</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span><span class="p">:</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Counter value: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="si">}</span><span class="s2">, seed value: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>            <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="k">for</span> <span class="n">fidx</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">):</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ad</span> <span class="o">=</span> <span class="n">anndata</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">backed</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>            <span class="c1"># ensure each epoch have different data order</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">[</span><span class="n">fidx</span><span class="p">])</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="n">total_mini_batches</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>                <span class="n">total_mini_batches</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_size</span> <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">[</span><span class="n">fidx</span><span class="p">])</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                <span class="c1"># Treat whole batch as one mini-batch</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">[</span><span class="n">fidx</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">[</span><span class="n">fidx</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                <span class="n">total_mini_batches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">[</span><span class="n">fidx</span><span class="p">])</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>            <span class="c1"># Find range of the batches assigned to this worker</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>            <span class="n">mini_batch_per_worker</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>                <span class="n">total_mini_batches</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_workers</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>            <span class="p">)</span>  <span class="c1"># This number is ALWAYS divisble by total_workers</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>            <span class="n">mini_batch_per_batch</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">[</span><span class="n">fidx</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">[</span><span class="n">fidx</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>            <span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_size</span>  <span class="c1"># Will be 1 if mini_batch_size is None</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="k">if</span> <span class="n">mini_batch_per_batch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>                <span class="n">mini_batch_per_batch</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Handle case when mini_batch_size &gt; batch size</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>            <span class="n">start_mini_batch_gidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_rank</span> <span class="o">*</span> <span class="n">mini_batch_per_worker</span>  <span class="c1"># a.k.a offset</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="n">end_mini_batch_gidx</span> <span class="o">=</span> <span class="n">start_mini_batch_gidx</span> <span class="o">+</span> <span class="n">mini_batch_per_worker</span>  <span class="c1"># exclusive</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>            <span class="n">start_batch_gidx</span> <span class="o">=</span> <span class="n">start_mini_batch_gidx</span> <span class="o">//</span> <span class="n">mini_batch_per_batch</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>            <span class="n">end_batch_gidx</span> <span class="o">=</span> <span class="n">end_mini_batch_gidx</span> <span class="o">//</span> <span class="n">mini_batch_per_batch</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>            <span class="c1"># Adjust the index of the first and last mini-batch in the first and last batch respectively</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>            <span class="c1"># Only apply when a batch contains multiple mini-batches</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>            <span class="n">current_worker_batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batches</span><span class="p">[</span><span class="n">fidx</span><span class="p">][</span><span class="n">start_batch_gidx</span> <span class="p">:</span> <span class="n">end_batch_gidx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>            <span class="k">if</span> <span class="n">mini_batch_per_batch</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>                <span class="c1"># Offset the index of first mini-batch</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>                <span class="n">current_worker_batches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>                    <span class="n">current_worker_batches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>                    <span class="o">+</span> <span class="p">(</span><span class="n">start_mini_batch_gidx</span> <span class="o">%</span> <span class="n">mini_batch_per_batch</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_size</span><span class="p">,</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                    <span class="n">current_worker_batches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>                <span class="p">)</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_worker_batches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>                    <span class="c1"># Offset the index of last mini-batch</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>                    <span class="n">total_mini_batches_exclude_last</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>                        <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_size</span> <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">current_worker_batches</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>                    <span class="p">)</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>                    <span class="n">remainder</span> <span class="o">=</span> <span class="n">mini_batch_per_worker</span> <span class="o">-</span> <span class="n">total_mini_batches_exclude_last</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>                    <span class="n">current_worker_batches</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>                        <span class="n">current_worker_batches</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>                        <span class="n">current_worker_batches</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">remainder</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_size</span><span class="p">,</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>                    <span class="p">)</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>            <span class="c1"># NOTE: Black magic to improve read performance during data yielding</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_worker_batches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>                <span class="n">current_worker_batches</span> <span class="o">=</span> <span class="n">current_worker_batches</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">current_worker_batches</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>            <span class="n">yielded_mini_batches</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_worker_batches</span><span class="p">):</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>                <span class="c1"># Fetch the whole block &amp; start yielding data</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>                <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mat_by_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_size</span><span class="p">):</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>                    <span class="c1"># index on the X coordinates</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>                    <span class="n">b_start</span><span class="p">,</span> <span class="n">b_end</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_size</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>                    <span class="c1"># index on the adata coordinates</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>                    <span class="n">global_start</span><span class="p">,</span> <span class="n">global_end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_size</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">b_start</span><span class="p">:</span><span class="n">b_end</span><span class="p">]</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">global_start</span><span class="p">,</span> <span class="n">global_end</span><span class="p">)</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>                    <span class="n">yielded_mini_batches</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>                    <span class="k">if</span> <span class="n">yielded_mini_batches</span> <span class="o">&gt;=</span> <span class="n">mini_batch_per_worker</span><span class="p">:</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>                        <span class="k">break</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>                <span class="k">if</span> <span class="n">yielded_mini_batches</span> <span class="o">&gt;=</span> <span class="n">mini_batch_per_worker</span><span class="p">:</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>                    <span class="k">break</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="protoplast.scrna.anndata.torch_dataloader.DistributedAnnDataset.transform" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">transform</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span></code>

<a href="#protoplast.scrna.anndata.torch_dataloader.DistributedAnnDataset.transform" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>The subclass should implement the logic to get more data for the cell. It can leverage this super function
to efficiently get X as a sparse tensor. An example of how to get to more data from the cell is
<code>self.ad.obs["key"][start:end]</code> where you must only fetch a subset of this data with <code>start</code> and <code>end</code></p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>start</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Starting index of this batch</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Ending index of this batch</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Usually a tensor, a list of tensor or dictionary with tensor value</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/protoplast/scrna/anndata/torch_dataloader.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="k">def</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;The subclass should implement the logic to get more data for the cell. It can leverage this super function</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">    to efficiently get X as a sparse tensor. An example of how to get to more data from the cell is</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">    `self.ad.obs[&quot;key&quot;][start:end]` where you must only fetch a subset of this data with `start` and `end`</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">    start : int</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">        Starting index of this batch</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">    end : int</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">        Ending index of this batch</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">    Returns</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">    -------</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">    Any</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">        Usually a tensor, a list of tensor or dictionary with tensor value</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>    <span class="c1"># by default we just return the matrix</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>    <span class="c1"># sometimes, the h5ad file stores X as the dense matrix,</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="c1"># so we have to make sure it is a sparse matrix before returning</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>    <span class="c1"># the batch item</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="c1"># we don&#39;t have the X upstream, so we have to incurr IO to fetch it</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mat_by_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>    <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_sparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>    <span class="k">return</span> <span class="n">X</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="protoplast.scrna.anndata.strategy.ShuffleStrategy" class="doc doc-heading">
            <code>protoplast.scrna.anndata.strategy.ShuffleStrategy</code>


<a href="#protoplast.scrna.anndata.strategy.ShuffleStrategy" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>


        <p>Strategy on how to data should be split and shuffle during
the training</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>file_paths</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of file paths</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How much data to fetch</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>total_workers</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Total workers this is equal to number of processes times number of threads per process</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>test_size</code>
            </td>
            <td>
                  <code><span title="float">float</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fraction of test data for example 0.1 means 10% will be split for testing, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>validation_size</code>
            </td>
            <td>
                  <code><span title="float">float</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fraction of validation data for example 0.2 means 20% will be split for validation, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>random_seed</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Seed to randomize the split set this to None if you want this to be completely random, by default 42</p>
              </div>
            </td>
            <td>
                  <code>42</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>metadata_cb</code>
            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[<span title="anndata.AnnData">AnnData</span>, <span title="dict">dict</span>], None] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Callback to mutate metadata recommended for passing data from <code>obs</code> or <code>var</code>
or any additional data your models required
by default cell_line_metadata_cb</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>is_shuffled</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to shuffle the data or not this will be deprecated soon, by default True</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/protoplast/scrna/anndata/strategy.py</code></summary>
                <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-242" name="__codelineno-0-242"></a><span class="k">class</span><span class="w"> </span><span class="nc">ShuffleStrategy</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Strategy on how to data should be split and shuffle during</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><span class="sd">    the training</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">    file_paths : list[str]</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">        List of file paths</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">    batch_size : int</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="sd">        How much data to fetch</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">    total_workers : int</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="sd">        Total workers this is equal to number of processes times number of threads per process</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a><span class="sd">    test_size : float | None, optional</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="sd">        Fraction of test data for example 0.1 means 10% will be split for testing, by default None</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="sd">    validation_size : float | None, optional</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="sd">        Fraction of validation data for example 0.2 means 20% will be split for validation, by default None</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a><span class="sd">    random_seed : int | None, optional</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a><span class="sd">        Seed to randomize the split set this to None if you want this to be completely random, by default 42</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="sd">    metadata_cb : Callable[[anndata.AnnData, dict], None] | None, optional</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a><span class="sd">        Callback to mutate metadata recommended for passing data from `obs` or `var`</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a><span class="sd">        or any additional data your models required</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a><span class="sd">        by default cell_line_metadata_cb</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a><span class="sd">    is_shuffled : bool, optional</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a><span class="sd">        Whether to shuffle the data or not this will be deprecated soon, by default True</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="n">file_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>        <span class="n">total_workers</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>        <span class="n">test_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="n">validation_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="n">metadata_cb</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">anndata</span><span class="o">.</span><span class="n">AnnData</span><span class="p">,</span> <span class="nb">dict</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>        <span class="n">is_shuffled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">file_paths</span> <span class="o">=</span> <span class="n">file_paths</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">total_workers</span> <span class="o">=</span> <span class="n">total_workers</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span> <span class="o">=</span> <span class="n">test_size</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">validation_size</span> <span class="o">=</span> <span class="n">validation_size</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">random_seed</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_cb</span> <span class="o">=</span> <span class="n">metadata_cb</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_shuffled</span> <span class="o">=</span> <span class="n">is_shuffled</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span> <span class="k">if</span> <span class="n">random_seed</span> <span class="k">else</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">()</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_mixer</span><span class="p">():</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>        <span class="k">return</span> <span class="kc">False</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SplitInfo</span><span class="p">:</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><span class="sd">        How you want to split the data in each worker must return SplitInfo</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="k">pass</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">mixer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">any</span><span class="p">:</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="sd">        If your Dataset only return 1 sample and not prebatched</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a><span class="sd">        this need to be implemented</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="protoplast.scrna.anndata.strategy.ShuffleStrategy.mixer" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mixer</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">any</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

<a href="#protoplast.scrna.anndata.strategy.ShuffleStrategy.mixer" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>If your Dataset only return 1 sample and not prebatched
this need to be implemented</p>


            <details class="quote">
              <summary>Source code in <code>src/protoplast/scrna/anndata/strategy.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-300" name="__codelineno-0-300"></a><span class="nd">@abstractmethod</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a><span class="k">def</span><span class="w"> </span><span class="nf">mixer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">any</span><span class="p">:</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a><span class="sd">    If your Dataset only return 1 sample and not prebatched</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a><span class="sd">    this need to be implemented</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="protoplast.scrna.anndata.strategy.ShuffleStrategy.split" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">split</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">SplitInfo</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

<a href="#protoplast.scrna.anndata.strategy.ShuffleStrategy.split" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>How you want to split the data in each worker must return SplitInfo</p>


            <details class="quote">
              <summary>Source code in <code>src/protoplast/scrna/anndata/strategy.py</code></summary>
              <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-293" name="__codelineno-0-293"></a><span class="nd">@abstractmethod</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a><span class="k">def</span><span class="w"> </span><span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SplitInfo</span><span class="p">:</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><span class="sd">    How you want to split the data in each worker must return SplitInfo</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="protoplast.scrna.anndata.strategy.SplitInfo" class="doc doc-heading">
            <code>protoplast.scrna.anndata.strategy.SplitInfo</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#protoplast.scrna.anndata.strategy.SplitInfo" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">









              <details class="quote">
                <summary>Source code in <code>src/protoplast/scrna/anndata/strategy.py</code></summary>
                <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-200" name="__codelineno-0-200"></a><span class="nd">@dataclass</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a><span class="k">class</span><span class="w"> </span><span class="nc">SplitInfo</span><span class="p">:</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>    <span class="n">files</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>    <span class="n">train_indices</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>    <span class="n">val_indices</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>    <span class="n">test_indices</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>    <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>    <span class="n">mini_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Information on how to split the data</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">    this will get pass to the Dataset to know which part of the data</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="sd">    they need to access</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a><span class="sd">    files : list[str]</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a><span class="sd">        List of files</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="sd">    train_indices : list[list[str]]</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a><span class="sd">        List of indices for training `train_indices[file_idx][batch_idx]` where `file_idx` must correspond</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="sd">        to the idx of `files` parameter</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a><span class="sd">    val_indices : list[list[str]]</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="sd">        List of indices for validation `val_indices[file_idx][batch_idx]` where `file_idx` must correspond</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="sd">        to the idx of `files` parameter</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="sd">    test_indices : list[list[str]]</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><span class="sd">        List of indices for testing `test_indices[file_idx][batch_idx]` where `file_idx` must correspond</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a><span class="sd">        to the idx of `files` parameter</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a><span class="sd">    metadata : dict[str, any]</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a><span class="sd">        Data to pass on to the Dataset and model</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a><span class="sd">    mini_batch_size : int | None</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a><span class="sd">        How much data to send to the model</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]:</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>            <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">,</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>            <span class="s2">&quot;train_indices&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_indices</span><span class="p">,</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>            <span class="s2">&quot;val_indices&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_indices</span><span class="p">,</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>            <span class="s2">&quot;test_indices&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_indices</span><span class="p">,</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>            <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>            <span class="s2">&quot;mini_batch_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_size</span><span class="p">,</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="protoplast.scrna.anndata.strategy.SplitInfo.mini_batch_size" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mini_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#protoplast.scrna.anndata.strategy.SplitInfo.mini_batch_size" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Information on how to split the data
this will get pass to the Dataset to know which part of the data
they need to access</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>files</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of files</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>train_indices</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="list">list</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of indices for training <code>train_indices[file_idx][batch_idx]</code> where <code>file_idx</code> must correspond
to the idx of <code>files</code> parameter</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>val_indices</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="list">list</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of indices for validation <code>val_indices[file_idx][batch_idx]</code> where <code>file_idx</code> must correspond
to the idx of <code>files</code> parameter</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>test_indices</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="list">list</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of indices for testing <code>test_indices[file_idx][batch_idx]</code> where <code>file_idx</code> must correspond
to the idx of <code>files</code> parameter</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>metadata</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="any">any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data to pass on to the Dataset and model</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mini_batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How much data to send to the model</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

    </div>

</div>






  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="protoplast.scrna.anndata.strategy.SequentialShuffleStrategy" class="doc doc-heading">
            <code>protoplast.scrna.anndata.strategy.SequentialShuffleStrategy</code>


<a href="#protoplast.scrna.anndata.strategy.SequentialShuffleStrategy" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="protoplast.scrna.anndata.strategy.ShuffleStrategy" href="#protoplast.scrna.anndata.strategy.ShuffleStrategy">ShuffleStrategy</a></code></p>


        <p>Return the data in a sequential way randomness is not guarantee
there is a high chance the data will come from nearby rows this might
affect your training accuracy depending on how the anndata are ordered you can
overcome this by preshuffling the data manually yourself if this is an issue</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>file_paths</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of file paths</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>batch_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How much data to fetch</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>total_workers</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Total workers this is equal to number of processes times number of threads per process</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>test_size</code>
            </td>
            <td>
                  <code><span title="float">float</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fraction of test data for example 0.1 means 10% will be split for testing, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>validation_size</code>
            </td>
            <td>
                  <code><span title="float">float</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fraction of validation data for example 0.2 means 20% will be split for validation, by default None</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>random_seed</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Seed to randomize the split set this to None if you want this to be completely random, by default 42</p>
              </div>
            </td>
            <td>
                  <code>42</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>metadata_cb</code>
            </td>
            <td>
                  <code><span title="collections.abc.Callable">Callable</span>[[<span title="anndata.AnnData">AnnData</span>, <span title="dict">dict</span>], None] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Callback to mutate metadata recommended for passing data from <code>obs</code> or <code>var</code>
or any additional data your models required
by default cell_line_metadata_cb</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>is_shuffled</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to shuffle the data or not this will be deprecated soon, by default True</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pre_fetch_then_batch</code>
            </td>
            <td>
                  <code><span title="int">int</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The prefetch factor the total size of data fetch will be equal to <code>pre_fetch_then_batch * batch_size</code></p>
              </div>
            </td>
            <td>
                  <code>16</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>drop_last</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If there is true drop the remainder, default to True otherwise duplicate the data to make sure the
data is evenly distributed to all the workers</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>src/protoplast/scrna/anndata/strategy.py</code></summary>
                <div class="language-python highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-309" name="__codelineno-0-309"></a><span class="k">class</span><span class="w"> </span><span class="nc">SequentialShuffleStrategy</span><span class="p">(</span><span class="n">ShuffleStrategy</span><span class="p">):</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the data in a sequential way randomness is not guarantee</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a><span class="sd">    there is a high chance the data will come from nearby rows this might</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a><span class="sd">    affect your training accuracy depending on how the anndata are ordered you can</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a><span class="sd">    overcome this by preshuffling the data manually yourself if this is an issue</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a><span class="sd">    file_paths : list[str]</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a><span class="sd">        List of file paths</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a><span class="sd">    batch_size : int</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a><span class="sd">        How much data to fetch</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a><span class="sd">    total_workers : int</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a><span class="sd">        Total workers this is equal to number of processes times number of threads per process</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a><span class="sd">    test_size : float | None, optional</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a><span class="sd">        Fraction of test data for example 0.1 means 10% will be split for testing, by default None</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a><span class="sd">    validation_size : float | None, optional</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a><span class="sd">        Fraction of validation data for example 0.2 means 20% will be split for validation, by default None</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a><span class="sd">    random_seed : int | None, optional</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a><span class="sd">        Seed to randomize the split set this to None if you want this to be completely random, by default 42</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a><span class="sd">    metadata_cb : Callable[[anndata.AnnData, dict], None] | None, optional</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a><span class="sd">        Callback to mutate metadata recommended for passing data from `obs` or `var`</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a><span class="sd">        or any additional data your models required</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a><span class="sd">        by default cell_line_metadata_cb</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a><span class="sd">    is_shuffled : bool, optional</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a><span class="sd">        Whether to shuffle the data or not this will be deprecated soon, by default True</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a><span class="sd">    pre_fetch_then_batch : int | None</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a><span class="sd">        The prefetch factor the total size of data fetch will be equal to `pre_fetch_then_batch * batch_size`</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a><span class="sd">    drop_last : bool</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a><span class="sd">        If there is true drop the remainder, default to True otherwise duplicate the data to make sure the</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a><span class="sd">        data is evenly distributed to all the workers</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>        <span class="n">file_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>        <span class="n">total_workers</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>        <span class="n">test_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>        <span class="n">validation_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>        <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>        <span class="n">metadata_cb</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">anndata</span><span class="o">.</span><span class="n">AnnData</span><span class="p">,</span> <span class="nb">dict</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>        <span class="n">is_shuffled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>        <span class="n">pre_fetch_then_batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>        <span class="n">drop_last</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>            <span class="n">file_paths</span><span class="p">,</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>            <span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>            <span class="n">total_workers</span><span class="p">,</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>            <span class="n">test_size</span><span class="p">,</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>            <span class="n">validation_size</span><span class="p">,</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>            <span class="n">random_seed</span><span class="p">,</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>            <span class="n">metadata_cb</span><span class="p">,</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>            <span class="n">is_shuffled</span><span class="p">,</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>        <span class="p">)</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pre_fetch_then_batch</span> <span class="o">=</span> <span class="n">pre_fetch_then_batch</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">drop_last</span> <span class="o">=</span> <span class="n">drop_last</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_disable_balancing</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_disable_balancing&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SplitInfo</span><span class="p">:</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>        <span class="n">split_dict</span> <span class="o">=</span> <span class="n">ann_split_data</span><span class="p">(</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">file_paths</span><span class="p">,</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">total_workers</span><span class="p">,</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span><span class="p">,</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">validation_size</span><span class="p">,</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">metadata_cb</span><span class="p">,</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">is_shuffled</span><span class="p">,</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">drop_last</span><span class="p">,</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>            <span class="n">prefetch_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_fetch_then_batch</span><span class="p">,</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>            <span class="n">is_disable_balancing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_disable_balancing</span><span class="p">,</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>        <span class="p">)</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>        <span class="c1"># this will be passed to the dataset, inorder to know the mini batch size</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_fetch_then_batch</span><span class="p">:</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>            <span class="n">split_dict</span><span class="p">[</span><span class="s2">&quot;mini_batch_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>            <span class="c1"># yield everything we read</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>            <span class="n">split_dict</span><span class="p">[</span><span class="s2">&quot;mini_batch_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>        <span class="k">return</span> <span class="n">SplitInfo</span><span class="p">(</span><span class="o">**</span><span class="n">split_dict</span><span class="p">)</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">mixer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">mixer</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Maintained by <a href="https://dataxight.com">dataxight</a>.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/dataxight/protoplast" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/protoplast" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 444.7a20.4 20.4 0 1 1 0-40.7 20.4 20.4 0 1 1 0 40.7M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.6-183.4a20.4 20.4 0 1 1 0 40.8 20.4 20.4 0 1 1 0-40.8"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>